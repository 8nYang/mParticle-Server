{"version":3,"sources":["public/mp/buy-coin.js"],"names":["express","require","buy_coin","Router","mParticle","config","Configuration","apiClient","ApiClient","basePath","api","EventsApi","random_choice","a_src","sel","Math","floor","random","length","weighted_random_choice","data","total","i","threshold","uuidv4","replace","c","r","v","toString","get","req","res","batch","Batch","Environment","development","context","user_identities","UserIdentities","query","customerid","mp_deviceid","d_games","a_lw_coins","a_lw_extra","a_coins","a_stellars","type","game","Object","keys","pm_product","Product","product_set","name","id","brand","category","quantity","price","custom_attributes","total_product_amount","randomCoins","c_sel","randomExtra","e_sel","product_action","ProductAction","products","total_amount","tax_amount","round","transaction_id","commerce_event","CommerceEvent","currency_code","timestamp_unixtime_ms","Date","now","addEvent","body","callback","error","response","send","header","JSON","stringify","bulkUploadEvents","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,OAAO,GAAGC,OAAO,CAAC,SAAD,CAArB;;AACA,IAAIC,QAAQ,GAAGF,OAAO,CAACG,MAAR,EAAf;;AACA,IAAIC,SAAS,GAAGH,OAAO,CAAC,WAAD,CAAvB,EAEA;AACA;;;AACA,IAAII,MAAM,GAAG,IAAID,SAAS,CAACE,aAAd,CACT,sCADS,EAET,kEAFS,CAAb;AAGA,IAAIC,SAAS,GAAG,IAAIH,SAAS,CAACI,SAAd,EAAhB;AACAD,SAAS,CAACE,QAAV,GAAqB,kCAArB;AACA,IAAIC,GAAG,GAAG,IAAIN,SAAS,CAACO,SAAd,CAAwBN,MAAxB,EAAgCE,SAAhC,CAAV;;AAEA,SAASK,aAAT,CAAuBC,KAAvB,EAA8B;EAC1B,IAAIC,GAAG,GAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,KAAgBJ,KAAK,CAACK,MAAjC,CAAV;EACA,OAAO,CAACL,KAAK,CAACC,GAAD,CAAN,EAAaA,GAAb,CAAP;AACH;;AAED,SAASK,sBAAT,CAAgCC,IAAhC,EAAsC;EAClC,IAAIC,KAAK,GAAG,CAAZ;;EACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,IAAI,CAACF,MAAzB,EAAiC,EAAEI,CAAnC,EAAsC;IAClCD,KAAK,IAAID,IAAI,CAACE,CAAD,CAAJ,CAAQ,CAAR,CAAT;EACH,CAJiC,CAKlC;EACA;;;EACA,MAAMC,SAAS,GAAGR,IAAI,CAACE,MAAL,KAAgBI,KAAlC;EAEAA,KAAK,GAAG,CAAR;;EACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,IAAI,CAACF,MAAL,GAAc,CAAlC,EAAqC,EAAEI,CAAvC,EAA0C;IACtC;IACAD,KAAK,IAAID,IAAI,CAACE,CAAD,CAAJ,CAAQ,CAAR,CAAT,CAFsC,CAItC;;IACA,IAAID,KAAK,IAAIE,SAAb,EAAwB;MACpB,OAAO,CAACH,IAAI,CAACE,CAAD,CAAJ,CAAQ,CAAR,CAAD,EAAaA,CAAb,CAAP;IACH;EACJ,CAlBiC,CAoBlC;;;EACA,OAAO,CAACF,IAAI,CAACA,IAAI,CAACF,MAAL,GAAc,CAAf,CAAJ,CAAsB,CAAtB,CAAD,EAA2BE,IAAI,CAACF,MAAL,GAAc,CAAzC,CAAP;AACH;;AAED,SAASM,MAAT,GAAkB;EACd,OAAO,uCAAuCC,OAAvC,CAA+C,OAA/C,EAAwD,UAASC,CAAT,EAAY;IACvE,IAAIC,CAAC,GAAGZ,IAAI,CAACE,MAAL,KAAgB,EAAhB,GAAqB,CAA7B;IAAA,IAAgCW,CAAC,GAAGF,CAAC,IAAI,GAAL,GAAWC,CAAX,GAAgBA,CAAC,GAAG,GAAJ,GAAU,GAA9D;IACA,OAAOC,CAAC,CAACC,QAAF,CAAW,EAAX,CAAP;EACH,CAHM,CAAP;AAIH;;AAED3B,QAAQ,CAAC4B,GAAT,CAAa,GAAb,EAAkB,UAASC,GAAT,EAAcC,GAAd,EAAmB;EAEjC,IAAIC,KAAK,GAAG,IAAI7B,SAAS,CAAC8B,KAAd,CAAoB9B,SAAS,CAAC8B,KAAV,CAAgBC,WAAhB,CAA4BC,WAAhD,CAAZ;EACAH,KAAK,CAACI,OAAN,GAAgB;IACZ,aAAa;MACT,WAAW,YADF;MAET,gBAAgB;IAFP;EADD,CAAhB;EAMA,IAAIC,eAAe,GAAG,IAAIlC,SAAS,CAACmC,cAAd,EAAtB;;EAEA,IAAI,gBAAgBR,GAAG,CAACS,KAAxB,EAA+B;IAC3BF,eAAe,CAACG,UAAhB,GAA6BV,GAAG,CAACS,KAAJ,CAAU,YAAV,CAA7B;EACH;;EACDP,KAAK,CAACK,eAAN,GAAwBA,eAAxB;EACAL,KAAK,CAACS,WAAN,GAAoB,sCAApB;EAEA,IAAIC,OAAO,GAAG;IACV,MAAM,gBADI;IAEV,MAAM,WAFI;IAGV,MAAM,SAHI;IAIV,MAAM;EAJI,CAAd;EAOA,IAAIC,UAAU,GAAG,CACb,CAAC,CAAC,OAAD,EAAU,OAAV,CAAD,EAAqB,KAArB,CADa,EAEb,CAAC,CAAC,OAAD,EAAU,OAAV,CAAD,EAAqB,IAArB,CAFa,EAGb,CAAC,CAAC,OAAD,EAAU,OAAV,CAAD,EAAqB,IAArB,CAHa,EAIb,CAAC,CAAC,OAAD,EAAU,OAAV,CAAD,EAAqB,IAArB,CAJa,EAKb,CAAC,CAAC,IAAD,EAAO,OAAP,CAAD,EAAkB,IAAlB,CALa,EAMb,CAAC,CAAC,IAAD,EAAO,OAAP,CAAD,EAAkB,KAAlB,CANa,CAAjB;EASA,IAAIC,UAAU,GAAG,CACb,CAAC,CAAC,MAAD,EAAS,MAAT,CAAD,EAAmB,IAAnB,CADa,EAEb,CAAC,CAAC,SAAD,EAAY,KAAZ,CAAD,EAAqB,IAArB,CAFa,EAGb,CAAC,CAAC,MAAD,EAAS,UAAT,CAAD,EAAuB,IAAvB,CAHa,EAIb,CAAC,CAAC,gBAAD,EAAmB,QAAnB,CAAD,EAA+B,IAA/B,CAJa,EAKb,CAAC,CAAC,SAAD,EAAY,KAAZ,CAAD,EAAqB,IAArB,CALa,EAMb,CAAC,CAAC,MAAD,EAAS,MAAT,CAAD,EAAmB,IAAnB,CANa,CAAjB;EASA,IAAIC,OAAO,GAAG,CACV,CAAC,WAAD,EAAc,SAAd,EAAyB,KAAzB,CADU,EAEV,CAAC,YAAD,EAAe,MAAf,EAAuB,IAAvB,CAFU,EAGV,CAAC,WAAD,EAAc,QAAd,EAAwB,KAAxB,CAHU,EAIV,CAAC,WAAD,EAAc,QAAd,EAAwB,KAAxB,CAJU,EAKV,CAAC,UAAD,EAAa,OAAb,EAAsB,IAAtB,CALU,EAMV,CAAC,WAAD,EAAc,OAAd,EAAuB,IAAvB,CANU,EAOV,CAAC,aAAD,EAAgB,OAAhB,EAAyB,IAAzB,CAPU,CAAd;EAUA,IAAIC,UAAU,GAAG,CACb,CAAC,WAAD,EAAc,OAAd,EAAuB,KAAvB,CADa,EAEb,CAAC,YAAD,EAAe,IAAf,EAAqB,IAArB,CAFa,EAGb,CAAC,WAAD,EAAc,MAAd,EAAsB,KAAtB,CAHa,EAIb,CAAC,WAAD,EAAc,MAAd,EAAsB,KAAtB,CAJa,EAKb,CAAC,UAAD,EAAa,KAAb,EAAoB,IAApB,CALa,EAMb,CAAC,WAAD,EAAc,KAAd,EAAqB,IAArB,CANa,EAOb,CAAC,aAAD,EAAgB,IAAhB,EAAsB,IAAtB,CAPa,CAAjB;EAUA,IAAIC,IAAI,GAAG,UAAUjB,GAAG,CAACS,KAAd,GAAoBT,GAAG,CAACS,KAAJ,CAAU,MAAV,CAApB,GAAsC5B,aAAa,CAAC,CAAC,MAAD,EAAS,SAAT,EAAoB,OAApB,CAAD,CAAb,CAA4C,CAA5C,CAAjD;EACA,IAAIqC,IAAI,GAAG,UAAUlB,GAAG,CAACS,KAAd,GAAoBT,GAAG,CAACS,KAAJ,CAAU,MAAV,CAApB,GAAsC5B,aAAa,CAACsC,MAAM,CAACC,IAAP,CAAYR,OAAZ,CAAD,CAAb,CAAoC,CAApC,CAAjD;EACA,IAAIS,UAAU,GAAG,IAAIhD,SAAS,CAACiD,OAAd,EAAjB;;EAEA,IAAIL,IAAI,IAAI,MAAZ,EAAoB;IAChB,IAAI,CAACM,WAAD,EAAcxC,GAAd,IAAqBF,aAAa,CAACkC,OAAD,CAAtC,CADgB,CAEhB;;IACAM,UAAU,CAACG,IAAX,GAAkB,aAAaD,WAAW,CAAC,CAAD,CAA1C;IACAF,UAAU,CAACI,EAAX,GAAgBP,IAAI,GAAG,UAAP,IAAqBnC,GAAG,GAAG,CAA3B,CAAhB;IACAsC,UAAU,CAACK,KAAX,GAAmB,iBAAnB;IACAL,UAAU,CAACM,QAAX,GAAsBf,OAAO,CAACM,IAAD,CAA7B;IACAG,UAAU,CAACO,QAAX,GAAsB,CAAtB;IACAP,UAAU,CAACQ,KAAX,GAAmBN,WAAW,CAAC,CAAD,CAA9B;IACAF,UAAU,CAACS,iBAAX,GAA+B,EAA/B;IACAT,UAAU,CAACS,iBAAX,CAA6B,cAA7B,IAA+CP,WAAW,CAAC,CAAD,CAA1D;IACAF,UAAU,CAACU,oBAAX,GAAkCV,UAAU,CAACO,QAAX,GAAsBP,UAAU,CAACQ,KAAnE;EACH,CAZD,MAYO,IAAIZ,IAAI,IAAI,SAAZ,EAAuB;IAC1B,IAAI,CAACM,WAAD,EAAcxC,GAAd,IAAqBF,aAAa,CAACmC,UAAD,CAAtC;IACAK,UAAU,CAACG,IAAX,GAAkB,gBAAgBD,WAAW,CAAC,CAAD,CAA7C;IACAF,UAAU,CAACI,EAAX,GAAgBP,IAAI,GAAG,aAAP,IAAwBnC,GAAG,GAAG,CAA9B,CAAhB;IACAsC,UAAU,CAACK,KAAX,GAAmB,iBAAnB;IACAL,UAAU,CAACM,QAAX,GAAsBf,OAAO,CAACM,IAAD,CAA7B;IACAG,UAAU,CAACO,QAAX,GAAsB,CAAtB;IACAP,UAAU,CAACQ,KAAX,GAAmBN,WAAW,CAAC,CAAD,CAA9B;IACAF,UAAU,CAACS,iBAAX,GAA+B,EAA/B;IACAT,UAAU,CAACS,iBAAX,CAA6B,iBAA7B,IAAkDP,WAAW,CAAC,CAAD,CAA7D;IACAF,UAAU,CAACU,oBAAX,GAAkCV,UAAU,CAACO,QAAX,GAAsBP,UAAU,CAACQ,KAAnE;EACH,CAXM,MAWA,IAAIZ,IAAI,IAAI,OAAZ,EAAqB;IACxB,IAAI,CAACe,WAAD,EAAcC,KAAd,IAAuB7C,sBAAsB,CAACyB,UAAD,CAAjD;IACA,IAAI,CAACqB,WAAD,EAAcC,KAAd,IAAuB/C,sBAAsB,CAAC0B,UAAD,CAAjD;IACAO,UAAU,CAACG,IAAX,GAAkB,YAAYQ,WAAW,CAAC,CAAD,CAAvB,GAA6B,KAA7B,GAAqCE,WAAW,CAAC,CAAD,CAAlE;IACAb,UAAU,CAACI,EAAX,GAAgBP,IAAI,GAAG,UAAP,IAAqBe,KAAK,GAAG,CAA7B,CAAhB;IACAZ,UAAU,CAACK,KAAX,GAAmB,iBAAnB;IACAL,UAAU,CAACM,QAAX,GAAsBf,OAAO,CAACM,IAAD,CAA7B;IACAG,UAAU,CAACO,QAAX,GAAsB,CAAtB;IACAP,UAAU,CAACQ,KAAX,GAAmB,IAAnB;IACAR,UAAU,CAACS,iBAAX,GAA+B,EAA/B;IACAT,UAAU,CAACS,iBAAX,CAA6B,cAA7B,IAA+CE,WAAW,CAAC,CAAD,CAA1D;IACAX,UAAU,CAACS,iBAAX,CAA6B,YAA7B,IAA6CI,WAAW,CAAC,CAAD,CAAxD;IACAb,UAAU,CAACS,iBAAX,CAA6B,YAA7B,IAA6CI,WAAW,CAAC,CAAD,CAAxD;IACAb,UAAU,CAACU,oBAAX,GAAkCV,UAAU,CAACO,QAAX,GAAsBP,UAAU,CAACQ,KAAnE;EACH;;EAED,IAAIO,cAAc,GAAG,IAAI/D,SAAS,CAACgE,aAAd,CAA4B,UAA5B,CAArB;EACAD,cAAc,CAACE,QAAf,GAA0B,CAACjB,UAAD,CAA1B;EACAe,cAAc,CAACG,YAAf,GAA8B,CAA9B;;EACA,KAAK,IAAIhD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG6C,cAAc,CAACE,QAAf,CAAwBnD,MAA5C,EAAoDI,CAAC,EAArD,EAAyD;IACrD6C,cAAc,CAACG,YAAf,IAA+BH,cAAc,CAACE,QAAf,CAAwB/C,CAAxB,EAA2BwC,oBAA1D;EACH;;EACDK,cAAc,CAACI,UAAf,GAA4BxD,IAAI,CAACyD,KAAL,CAAWL,cAAc,CAACG,YAAf,GAA8B,GAA9B,GAAoC,GAA/C,IAAsD,GAAlF;EACAH,cAAc,CAACM,cAAf,GAAgC,QAAQxB,IAAR,GAAe,GAAf,GAAqBzB,MAAM,EAA3D;EAEA,IAAIkD,cAAc,GAAG,IAAItE,SAAS,CAACuE,aAAd,EAArB;EACAD,cAAc,CAACP,cAAf,GAAgCA,cAAhC;EACAO,cAAc,CAACE,aAAf,GAA+B,KAA/B;EACAF,cAAc,CAACb,iBAAf,GAAmC,EAAnC;EACAa,cAAc,CAACb,iBAAf,CAAiC,cAAjC,IAAmD,iBAAnD;EACAa,cAAc,CAACb,iBAAf,CAAiC,MAAjC,IAA2ClB,OAAO,CAACM,IAAD,CAAlD;;EACA,IAAI,WAAWlB,GAAG,CAACS,KAAnB,EAA0B;IACtBkC,cAAc,CAACb,iBAAf,CAAiC,OAAjC,IAA4C9B,GAAG,CAACS,KAAJ,CAAU,OAAV,CAA5C;EACH;;EACDkC,cAAc,CAACG,qBAAf,GAAuCC,IAAI,CAACC,GAAL,EAAvC,CA3HiC,CA2HkB;;EAEnD9C,KAAK,CAAC+C,QAAN,CAAeN,cAAf;EAEA,IAAIO,IAAI,GAAG,CAAChD,KAAD,CAAX;;EACA,IAAIiD,QAAQ,GAAG,UAASC,KAAT,EAAgB/D,IAAhB,EAAsBgE,QAAtB,EAAgC;IAC3C,IAAID,KAAJ,EAAW;MACPnD,GAAG,CAACqD,IAAJ,CAAS,YAAYF,KAArB;IACH,CAFD,MAEO;MACHnD,GAAG,CAACsD,MAAJ,CAAW,cAAX,EAA0B,kBAA1B;MACAtD,GAAG,CAACqD,IAAJ,CAASE,IAAI,CAACC,SAAL,CAAe;QACpB,QAAQ7C,OAAO,CAACM,IAAD,CADK;QAEpB,kBAAkBkB,cAAc,CAACG,YAFb;QAGpB,iBAAiBtB,IAAI,IAAI,SAAR,GAAkB,UAAlB,GAA8B,OAH3B;QAIpB,mBAAmBA,IAAI,IAAI,SAAR,GAAkBI,UAAU,CAACS,iBAAX,CAA6B,iBAA7B,CAAlB,GAAkET,UAAU,CAACS,iBAAX,CAA6B,cAA7B;MAJjE,CAAf,EAKN,IALM,EAKA,CALA,CAAT;IAMH;EACJ,CAZD;;EAcAnD,GAAG,CAAC+E,gBAAJ,CAAqBR,IAArB,EAA2BC,QAA3B;AAEH,CAhJD;AAkJAQ,MAAM,CAACC,OAAP,GAAiBzF,QAAjB","file":"buy-coin.js","sourceRoot":"../src","sourcesContent":["var express = require('express');\nvar buy_coin = express.Router();\nvar mParticle = require('mparticle');\n\n//https://demo.mp.com/mp/buy_coin?customerid=98760603&token=220672716078290600703\n//mParticle Workshop ---> easyJet ---> Custom Feed ---> eRes System\nvar config = new mParticle.Configuration(\n    'us2-df5e5532f3db7f4b8365fb6fa1e3ad6a',\n    'h0KGtAfdvVB-OFaeyV9zAnQNXXUjybgOTEQetk_lmbqOWgFetL4jfSpDJvWSz_mq');\nvar apiClient = new mParticle.ApiClient()\napiClient.basePath = 'https://s2s.us2.mparticle.com/v2'\nvar api = new mParticle.EventsApi(config, apiClient);\n\nfunction random_choice(a_src) {\n    var sel = Math.floor(Math.random() * a_src.length)\n    return [a_src[sel], sel];\n}\n\nfunction weighted_random_choice(data) {\n    let total = 0;\n    for (let i = 0; i < data.length; ++i) {\n        total += data[i][1];\n    }\n    // Total in hand, we can now pick a random value akin to our\n    // random index from before.\n    const threshold = Math.random() * total;\n    \n    total = 0;\n    for (let i = 0; i < data.length - 1; ++i) {\n        // Add the weight to our running total.\n        total += data[i][1];\n\n        // If this value falls within the threshold, we're done!\n        if (total >= threshold) {\n            return [data[i][0], i];\n        }\n    }\n\n    // Wouldn't you know it, we needed the very last entry!\n    return [data[data.length - 1][0], data.length - 1];\n}\n\nfunction uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n    });\n}\n\nbuy_coin.get('/', function(req, res) {\n    \n    var batch = new mParticle.Batch(mParticle.Batch.Environment.development);\n    batch.context = { \n        \"data_plan\": {\n            \"plan_id\": \"dp_example\",\n            \"plan_version\": 1\n        }\n    }\n    var user_identities = new mParticle.UserIdentities();\n    \n    if ('customerid' in req.query) {\n        user_identities.customerid = req.query['customerid']\n    }\n    batch.user_identities = user_identities;\n    batch.mp_deviceid = \"87d2ebaa-e956-407e-a1e6-f05f871bf4e6\"\n    \n    let d_games = {\n        \"LL\": \"Lightning Link\",\n        \"MF\": \"Mighty Fu\",\n        \"CM\": \"Cashman\",\n        \"HV\": \"Heart of Vegas\"\n    };\n    \n    let a_lw_coins = [\n        [[\"4.75M\", 4750000], 0.375],\n        [[\"4.25M\", 4250000], 0.33],\n        [[\"5.25M\", 5250000], 0.12],\n        [[\"6.75M\", 6750000], 0.07],\n        [[\"8M\", 8000000], 0.03],\n        [[\"6M\", 6000000], 0.044]\n    ];\n    \n    let a_lw_extra = [\n        [[\"Orbs\", \"RARE\"], 0.32],\n        [[\"Stellar\", 15000], 0.30],\n        [[\"Orbs\", \"UNCOMMON\"], 0.30],\n        [[\"Ligtning Boost\", \"10Mins\"], 0.02],\n        [[\"Stellar\", 20000], 0.03],\n        [[\"Orbs\", \"EPIC\"], 0.01]\n    ];\n\n    let a_coins = [\n        [\"600% MORE\", 110000000, 99.99],\n        [\"GOOD VALUE\", 320000, 1.99],\n        [\"400% MORE\", 38000000, 49.99],\n        [\"300% MORE\", 13000000, 19.99],\n        [\"65% MORE\", 1300000, 4.99],\n        [\"150% MORE\", 4000000, 9.99],\n        [\"GREAT VALUE\", 1000000, 2.99]\n    ];\n    \n    let a_stellars = [\n        [\"700% MORE\", 1000000, 99.99],\n        [\"GOOD VALUE\", 2500, 1.99],\n        [\"460% MORE\", 350000, 49.99],\n        [\"300% MORe\", 100000, 19.99],\n        [\"60% MORE\", 10000, 4.99],\n        [\"140% MORE\", 30000, 9.99],\n        [\"GREAT VALUE\", 4000, 2.99]\n    ];\n    \n    var type = 'type' in req.query?req.query['type']:random_choice([\"Coin\", \"Stellar\", \"Wheel\"])[0];\n    var game = 'game' in req.query?req.query['game']:random_choice(Object.keys(d_games))[0];\n    var pm_product = new mParticle.Product();\n    \n    if (type == \"Coin\") {\n        var [product_set, sel] = random_choice(a_coins);\n        //console.log(\"Product Set: \" + product_set)\n        pm_product.name = \"Coins - \" + product_set[0];\n        pm_product.id = game + \"-COIN-00\" + (sel + 1);\n        pm_product.brand = \"Product Madness\";\n        pm_product.category = d_games[game];\n        pm_product.quantity = 1;\n        pm_product.price = product_set[2];\n        pm_product.custom_attributes = {};\n        pm_product.custom_attributes['Coins_Amount'] = product_set[1];\n        pm_product.total_product_amount = pm_product.quantity * pm_product.price;\n    } else if (type == \"Stellar\") {\n        var [product_set, sel] = random_choice(a_stellars);\n        pm_product.name = \"Stellars - \" + product_set[0];\n        pm_product.id = game + \"-STELLAR-00\" + (sel + 1);\n        pm_product.brand = \"Product Madness\";\n        pm_product.category = d_games[game];\n        pm_product.quantity = 1;\n        pm_product.price = product_set[2];\n        pm_product.custom_attributes = {};\n        pm_product.custom_attributes['Stellars_Amount'] = product_set[1];\n        pm_product.total_product_amount = pm_product.quantity * pm_product.price;\n    } else if (type == \"Wheel\") {\n        var [randomCoins, c_sel] = weighted_random_choice(a_lw_coins);\n        var [randomExtra, e_sel] = weighted_random_choice(a_lw_extra);\n        pm_product.name = \"DRAW - \" + randomCoins[0] + \" + \" + randomExtra[0];\n        pm_product.id = game + \"-DRAW-00\" + (c_sel + 1);\n        pm_product.brand = \"Product Madness\";\n        pm_product.category = d_games[game];\n        pm_product.quantity = 1;\n        pm_product.price = 9.99;\n        pm_product.custom_attributes = {};\n        pm_product.custom_attributes['Coins_Amount'] = randomCoins[1];\n        pm_product.custom_attributes['Extra_Type'] = randomExtra[0];\n        pm_product.custom_attributes['Extra_Unit'] = randomExtra[1];\n        pm_product.total_product_amount = pm_product.quantity * pm_product.price;\n    }\n    \n    var product_action = new mParticle.ProductAction('purchase');\n    product_action.products = [pm_product];\n    product_action.total_amount = 0;\n    for (var i = 0; i < product_action.products.length; i++) {\n        product_action.total_amount += product_action.products[i].total_product_amount;\n    }\n    product_action.tax_amount = Math.round(product_action.total_amount * 0.2 * 100) / 100;\n    product_action.transaction_id = \"PM-\" + game + \"-\" + uuidv4();\n\n    var commerce_event = new mParticle.CommerceEvent();\n    commerce_event.product_action = product_action;\n    commerce_event.currency_code = \"GBP\";\n    commerce_event.custom_attributes = {};\n    commerce_event.custom_attributes['Payment_Type'] = \"In App Purchase\";\n    commerce_event.custom_attributes['Game'] = d_games[game];\n    if ('token' in req.query) {\n        commerce_event.custom_attributes['Token'] = req.query['token'];\n    }\n    commerce_event.timestamp_unixtime_ms = Date.now(); //replace with time of transaction\n\n    batch.addEvent(commerce_event);\n    \n    var body = [batch]\n    var callback = function(error, data, response) {\n        if (error) {\n            res.send('Error: ' + error);\n        } else {\n            res.header(\"Content-Type\",'application/json');\n            res.send(JSON.stringify({\n                'Game': d_games[game],\n                'Payment_Amount': product_action.total_amount,\n                'Purchase_Item': type == \"Stellar\"?\"Stellars\": \"Coins\",\n                'Purchase_Amount': type == \"Stellar\"?pm_product.custom_attributes['Stellars_Amount']:pm_product.custom_attributes['Coins_Amount']\n            }, null, 4));\n        }\n    };\n\n    api.bulkUploadEvents(body, callback);\n\n});\n\nmodule.exports = buy_coin;\n"]}