{"version":3,"sources":["public/mp/push-notification.js"],"names":["express","require","push_notification","Router","mParticle","logger","exec","config","Configuration","apiClient","ApiClient","basePath","api","EventsApi","random_choice","a_src","sel","Math","floor","random","length","weighted_random_choice","data","total","i","threshold","uuidv4","replace","c","r","v","toString","get","req","res","s_cmd","query","error","stdout","stderr","console","log","message","batch","Batch","Environment","development","context","user_identities","UserIdentities","customerid","mp_deviceid","s_campaign_id","event","AppEvent","CustomEventType","other","custom_attributes","Date","toISOString","split","addEvent","body","callback","response","send","header","JSON","stringify","trim","bulkUploadEvents","module","exports"],"mappings":"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","file":"push-notification.js","sourceRoot":"../src","sourcesContent":["var express = require('express');\nvar push_notification = express.Router();\nvar mParticle = require('mparticle');\nvar logger = require('morgan');\nconst { exec } = require(\"child_process\");\n\n\n//https://demo.mp.com/mp/push_notification?customerid=31160825&title=Great%20Offer%21&body=You%20Cannot%20Miss%20This%21&app=Matas\nvar config = new mParticle.Configuration(\n    'us2-4a4f4fa3a0464a4492a543888119fe3e',\n    'xfgWFOlV_CO2ha65v5QK4Md8WXey1wIlm2N_qVJo6A-1fy0y1XMwFiWQRqCon0us');\nvar apiClient = new mParticle.ApiClient()\napiClient.basePath = 'https://s2s.us2.mparticle.com/v2'\nvar api = new mParticle.EventsApi(config, apiClient);\n\nfunction random_choice(a_src) {\n    var sel = Math.floor(Math.random() * a_src.length)\n    return [a_src[sel], sel];\n}\n\nfunction weighted_random_choice(data) {\n    let total = 0;\n    for (let i = 0; i < data.length; ++i) {\n        total += data[i][1];\n    }\n    // Total in hand, we can now pick a random value akin to our\n    // random index from before.\n    const threshold = Math.random() * total;\n    \n    total = 0;\n    for (let i = 0; i < data.length - 1; ++i) {\n        // Add the weight to our running total.\n        total += data[i][1];\n\n        // If this value falls within the threshold, we're done!\n        if (total >= threshold) {\n            return [data[i][0], i];\n        }\n    }\n\n    // Wouldn't you know it, we needed the very last entry!\n    return [data[data.length - 1][0], data.length - 1];\n}\n\nfunction uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n    });\n}\n\npush_notification.get('/', function(req, res) {\n    var s_cmd = \"sleep 3;sed -i \\\"\\\" -e 's/^.*title.*$/            \\\"title\\\": \\\"\" + req.query['title'] + \"\\\"/' -e 's/^.*body.*$/            \\\"body\\\": \\\"\" + req.query['body'] + \"\\\",/' \\\"/Users/hsyang/Downloads/Prospects/Demo iOS App - \" + req.query['app'] + \"/push.json\\\";xcrun simctl push booted mParticle.demo-org \\\"/Users/hsyang/Downloads/Prospects/Demo iOS App - \" + req.query['app'] + \"/push.json\\\"\";\n    //console.log(s_cmd)\n    exec(s_cmd, (error, stdout, stderr) => {\n        if (error) {\n            console.log(`error: ${error.message}`);\n            return;\n        }\n        if (stderr) {\n            console.log(`stderr: ${stderr}`);\n            return;\n        }\n        \n        var batch = new mParticle.Batch(mParticle.Batch.Environment.development);\n        batch.context = { \n            \"data_plan\": {\n                \"plan_id\": \"dp_example\",\n                \"plan_version\": 1\n            }\n        }\n        \n        var user_identities = new mParticle.UserIdentities();\n    \n        if ('customerid' in req.query) {\n            user_identities.customerid = req.query['customerid']\n        }\n        batch.user_identities = user_identities;\n        batch.mp_deviceid = \"87d2ebaa-e956-407e-a1e6-f05f871bf4e6\"\n    \n        var s_campaign_id = \"2023-\" + uuidv4();\n        var event = new mParticle.AppEvent(mParticle.AppEvent.CustomEventType.other, 'Push Notification Deliveries');\n        event.custom_attributes = {\n            \"Campaign_Subject\": req.query['title'],\n            \"Campaign_ID\": s_campaign_id,\n            \"Mobile_ID\": req.query['customerid'],\n            \"Notfication_Time\": (new Date().toISOString().split(\".\")[0]+\"+00:00\")\n        };\n        \n        batch.addEvent(event);\n    \n        var body = [batch]\n        var callback = function(error, data, response) {\n            if (error) {\n                res.send('Error: ' + error);\n            } else {\n                res.header(\"Content-Type\",'application/json');\n                res.send(JSON.stringify({\n                    'Notification_Result': stdout.trim(),\n                    'Mobile_ID': req.query['customerid'],\n                    'Campaign_Subject': req.query['title'],\n                    'Campaign_ID': s_campaign_id\n                }, null, 4));\n            }\n        };\n\n        api.bulkUploadEvents(body, callback);\n    });\n\n});\n\nmodule.exports = push_notification;"]}